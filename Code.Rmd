---
title: "Code"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import Libraries
```{r}
library(haven)
library(broom)
library(magrittr)
library(dplyr)
library(arm)
library(ggplot2)
library(stats)
library(tidyr)
library(fastDummies)
```

# Load Data
```{r}
data0 <- read_sav("/Users/namrata/Downloads/Bielby276/DATA.sav")
data1 <- data0 %>% drop_na(E2_1G)
data2 <- filter(data1, S1 > -1 & S2> -1 & S3 > -1 & S4 > -1 & I1 > -1 & I2 > -1)
data2$REL1[data2$REL1<0] <- 14 # Recoding those who refused to answer as 14
```

# Listing confounders, treatment and outcome
Treatment - 1 where response to I3 is 1 or 2, else 0

Is this treatment variable manipulable?  

Outcome - E2_1G , 1(strongly favour) to 5(strongly oppose) 

Confounders - 

1. S1 to S4
2. I1 I2
3. PARTY7 - categorical - make dummy
4. REL1 - categorical - make dummy (1-14_)
5. REL2 - continuous(1-9)
6. Demographics -
PPAGE - continuous age varibale
<!-- PPAGECAT - age divided into 7 categories -->
<!-- PPAGECAT4 - age divided into 4 categories -->

Choose one of the above and make dummies for categorical

<!-- PPEDUC - education into 14 categories -->
PPEDUCAT - education into 4 categories

Choose one of the above and make dummies for categorical

PPETHM - race/ethnicity categorical - make dummy
PPGENDER - gender categorical, this will be mapped to gender_cat = 1 if male else 0
PPHHHEAD - household head categorical
PPHHSIZE - continuous
PPHOUSE - housing type categorical - make dummy
PPINCIMP - house hold income categorical - make dummy
PPMARIT - Marital status categorical - make dummy
PPMSACAT - msa status categorical - make dummy

PPREG4 - which region of america 4 categories
<!-- ppreg9 - which region of america 9 categories -->

Choose one of the above and make dummies for categorical

PPRENT - ownership status of home categorical - make dummy - highly likely to be correlated with house hold income

Presence (binary) of household members in that age group - discuss with Namrata
PPT01
PPT25
PPT612
PPT1317
PPT18OV

PPWORK - current employment status categorical - make dummy
PPNET - internet access presence categorical 1/0

ESTIMAND - ATT

Approaches - 

Prop score w/ 1-1 matching
IPTW 
GenMatch
BART


# Data Preprocessing
```{r}
data3  <- data2 %>% mutate(treatment_var = ifelse(I3 == 1 | I3 == 2, 1, 0)) %>% mutate(outcome_var = (E2_1G+E2_2G+E2_3G+E2_4G+E2_5G+E2_6GA+E2_7G+E2_8GA)/8)
data4 <- data3 %>% mutate(gender_cat = ifelse(PPGENDER == 1, 1, 0))
data5 <- dummy_cols(data4, select_columns=c('S1', 'S2', 'S3', 'S4', 'I1', 
                                            'I2', 'PARTY7', 'REL1', 'REL2', 'PPEDUCAT','PPETHM', 'PPHOUSE', 'PPINCIMP', 'PPMARIT','PPMSACAT', 'PPREG4', 'PPRENT', 'PPWORK'))
```

# Prop score + 1-1 matching w/ replacement
```{r}
matchitobject0 = MatchIt::matchit(treatment_var ~ S1_1 + S1_2 + S1_3 + S1_4 + S2_1 + S2_2 + S2_3 + S2_4 + + S3_1 + S3_2 + S3_3 + S3_4 + S4_1 + S4_2 + S4_3 + S4_4 + I1_1 + I1_2 + I1_3 + I1_4 + I2_1 + I2_2 + I2_3 + I2_4 + PARTY7_1 + PARTY7_2 + PARTY7_3 + PARTY7_4 + PARTY7_5 + PARTY7_6 + PARTY7_7 + REL1_1 + REL1_2 + REL1_3 + REL1_4 +  factor(S1) + factor(S2) + factor(S3) + factor(S4) + factor(I1) + factor(I2) + factor(PARTY7) + factor(REL1) + factor(REL2) + PPAGE + factor(PPEDUCAT) + factor(PPETHM) + gender_cat + PPHHHEAD + PPHHSIZE + factor(PPHOUSE) + factor(PPINCIMP) + factor(PPMARIT) + factor(PPMSACAT) + factor(PPREG4) + factor(PPRENT) + PPT01 + PPT25 + PPT612 + PPT1317 + PPT18OV + factor(PPWORK) + PPNET, data5, distance = "glm", link = "probit", replace = TRUE, method = "nearest")
matchitobject0_sum <- summary(matchitobject0)
matchitobject0_sum
plot(matchitobject0_sum, var.order = "matched") 
# plot(matchitobject0, type='density', which.xs = c("factor(S1)", "factor(S2)", "factor(S3)"))
```




